<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fraccionador de Logs - Trivial IRC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 700px;
            width: 100%;
            padding: 40px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 0.9em;
        }

        .upload-area {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #fafafa;
            margin-bottom: 30px;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .file-input {
            display: none;
        }

        .options {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-label {
            display: block;
            color: #555;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .option-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .process-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            display: none;
            transition: all 0.3s ease;
        }

        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .process-btn.show {
            display: block;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
        }

        .status.error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ef5350;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #64b5f6;
        }

        .status.show {
            display: block;
        }

        .results {
            display: none;
            margin-top: 30px;
        }

        .results.show {
            display: block;
        }

        .file-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .download-btn {
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .download-btn:hover {
            background: #5a67d8;
        }

        .download-all-btn {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .download-all-btn:hover {
            background: #218838;
        }

        .extras-section {
            background: #f0f4ff;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .extras-title {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .file-selected {
            background: #e8f5e9;
            border-color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📂 Fraccionador de Logs IRC</h1>
        <p class="subtitle">Limpia y divide tus logs de partidas con análisis estadístico</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">📁</div>
            <div id="uploadText">Arrastra tu archivo aquí o haz clic para seleccionar</div>
            <input type="file" id="fileInput" class="file-input" accept=".txt,.log">
        </div>

        <div class="options">
            <div class="option-group">
                <label class="option-label" for="numParts">Número de partes:</label>
                <input type="number" id="numParts" class="option-input" min="2" max="20" value="4">
            </div>
            
            <div class="option-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="cleanIRC" checked>
                    <label for="cleanIRC">Limpiar códigos IRC</label>
                </div>
            </div>

            <div class="extras-section">
                <div class="extras-title">📊 Análisis Extra (para Cronista)</div>
                <div class="checkbox-group">
                    <input type="checkbox" id="addExtras">
                    <label for="addExtras">Añadir estadísticas y análisis en cada corte</label>
                </div>
            </div>
        </div>

        <button id="processBtn" class="process-btn">Procesar Archivo</button>
        <div id="status" class="status"></div>
        <div id="results" class="results"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        let selectedFile = null;
        let processedFiles = [];

        // Clase para análisis de partida
        class AnalizadorPartida {
            constructor() {
                this.botNick = null;
                this.equipos = {};
                this.jugadorEquipo = {};
                this.puntosPorJugador = {};
                this.scratchesPorJugador = {};
                this.acesPorJugador = {};
                this.palosPorJugador = {};
                this.preguntaActual = 0;
                this.puntosEquipo = {};
                this.rachaActual = {};
                this.mejorRacha = {};
                this.jugadoresActivos = new Set();
                this.tiemposPorPregunta = {};
                this.respuestasPorPregunta = {};
                this.primerAcertantePorPregunta = {};
            }

            identificarBot(lineas) {
                for (const linea of lineas) {
                    if (linea.includes('--- Equipos participantes ---')) {
                        const match = linea.match(/<([^>]+)>/);
                        if (match) {
                            this.botNick = match[1];
                            return;
                        }
                    }
                }
            }

            procesarEquipos(lineas) {
                let dentroEquipos = false;
                let equipoActual = null;

                for (const linea of lineas) {
                    if (linea.includes('--- Equipos participantes ---')) {
                        dentroEquipos = true;
                        continue;
                    }
                    
                    if (linea.includes('--- DATOS RESETEADOS ---')) {
                        dentroEquipos = false;
                        break;
                    }

                    if (dentroEquipos && this.botNick && linea.includes(`<${this.botNick}>`)) {
                        if (!linea.includes('>>>')) {
                            // Es un nombre de equipo
                            const equipos = ['FOGUETES', 'LIDERES', 'KAMIKAZES', 'ATIPIK@S', 'REPESCA@S', 'HARDBE@TS', 'TELERINEZ'];
                            for (const eq of equipos) {
                                if (linea.includes(eq)) {
                                    equipoActual = eq;
                                    this.equipos[equipoActual] = [];
                                    this.puntosEquipo[equipoActual] = 0;
                                    break;
                                }
                            }
                        } else if (linea.includes('>>>') && equipoActual) {
                            // Lista de jugadores
                            const match = linea.match(/>>>\s*(.+)/);
                            if (match) {
                                const jugadores = match[1].trim().split(/\s+/);
                                this.equipos[equipoActual] = jugadores;
                                jugadores.forEach(j => {
                                    this.jugadorEquipo[j] = equipoActual;
                                    this.puntosPorJugador[j] = 0;
                                    this.scratchesPorJugador[j] = 0;
                                    this.acesPorJugador[j] = 0;
                                    this.palosPorJugador[j] = 0;
                                    this.rachaActual[j] = 0;
                                    this.mejorRacha[j] = 0;
                                });
                            }
                        }
                    }
                }
            }

            procesarLinea(linea, indice) {
                // Detectar actividad de jugadores
                const matchJugador = linea.match(/<([^>]+)>\s+(.+)/);
                if (matchJugador && matchJugador[1] !== this.botNick) {
                    const nick = matchJugador[1];
                    if (this.jugadorEquipo[nick]) {
                        this.jugadoresActivos.add(nick);
                    }
                }

                if (!this.botNick || !linea.includes(`<${this.botNick}>`)) {
                    return;
                }

                // Detectar número de pregunta
                const matchPregunta = linea.match(/Pregunta:\s*(\d+)\s*\/\s*\d+/);
                if (matchPregunta) {
                    this.preguntaActual = parseInt(matchPregunta[1]);
                    const matchTimestamp = linea.match(/^(\d{2}:\d{2}:\d{2})/);
                    if (matchTimestamp) {
                        this.tiemposPorPregunta[this.preguntaActual] = {
                            inicio: matchTimestamp[1],
                            primerAcierto: null
                        };
                    }
                    this.respuestasPorPregunta[this.preguntaActual] = [];
                }

                // Detectar scratch
                const matchScratch = linea.match(/>>>(\S+)\s+scratchea/);
                if (matchScratch) {
                    const jugador = matchScratch[1];
                    this.procesarAcierto(jugador, 'scratch', linea);
                }

                // Detectar ace
                const matchAce = linea.match(/>>>(\S+)\s+acea/);
                if (matchAce) {
                    const jugador = matchAce[1];
                    this.procesarAcierto(jugador, 'ace', linea);
                }

                // Detectar acierto normal
                const matchAcierto = linea.match(/>>>(\S+)\s+a\s+\d{2}''\d{2}/);
                if (matchAcierto) {
                    const jugador = matchAcierto[1];
                    this.procesarAcierto(jugador, 'normal', linea);
                }

                // Detectar palo
                const matchPalo = linea.match(/primer@?\s+sin\s+puntos:.*?>>>(\S+)/);
                if (matchPalo) {
                    const jugador = matchPalo[1];
                    if (this.palosPorJugador[jugador] !== undefined) {
                        this.palosPorJugador[jugador]++;
                        this.rachaActual[jugador] = 0;
                    }
                }

                // Detectar respuesta correcta
                const matchRespuesta = linea.match(/La buena:|Las buenas:/);
                if (matchRespuesta && this.preguntaActual) {
                    const matchTimestamp = linea.match(/^(\d{2}:\d{2}:\d{2})/);
                    if (matchTimestamp && this.tiemposPorPregunta[this.preguntaActual]) {
                        this.tiemposPorPregunta[this.preguntaActual].respuesta = matchTimestamp[1];
                    }
                }
            }

            procesarAcierto(jugador, tipo, linea) {
                if (this.puntosPorJugador[jugador] !== undefined) {
                    this.puntosPorJugador[jugador]++;
                    
                    if (this.jugadorEquipo[jugador]) {
                        this.puntosEquipo[this.jugadorEquipo[jugador]]++;
                    }

                    if (tipo === 'scratch') {
                        this.scratchesPorJugador[jugador]++;
                        if (!this.primerAcertantePorPregunta[this.preguntaActual]) {
                            this.primerAcertantePorPregunta[this.preguntaActual] = jugador;
                            const matchTimestamp = linea.match(/^(\d{2}:\d{2}:\d{2})/);
                            if (matchTimestamp && this.tiemposPorPregunta[this.preguntaActual]) {
                                this.tiemposPorPregunta[this.preguntaActual].primerAcierto = matchTimestamp[1];
                            }
                        }
                    } else if (tipo === 'ace') {
                        this.acesPorJugador[jugador]++;
                        this.scratchesPorJugador[jugador]++;
                    }

                    // Actualizar racha
                    this.rachaActual[jugador]++;
                    if (this.rachaActual[jugador] > this.mejorRacha[jugador]) {
                        this.mejorRacha[jugador] = this.rachaActual[jugador];
                    }

                    this.respuestasPorPregunta[this.preguntaActual].push(jugador);
                }
            }

            calcularTiempoRespuesta(pregunta) {
                const tiempos = this.tiemposPorPregunta[pregunta];
                if (!tiempos || !tiempos.inicio || !tiempos.primerAcierto) {
                    return null;
                }

                const [h1, m1, s1] = tiempos.inicio.split(':').map(Number);
                const [h2, m2, s2] = tiempos.primerAcierto.split(':').map(Number);
                
                const segundos1 = h1 * 3600 + m1 * 60 + s1;
                const segundos2 = h2 * 3600 + m2 * 60 + s2;
                
                let diferencia = segundos2 - segundos1;
                if (diferencia < 0) diferencia += 86400; // Cambio de día
                
                return diferencia;
            }

            obtenerPreguntaMasRapida() {
                let masRapida = null;
                let menorTiempo = Infinity;

                for (const pregunta in this.tiemposPorPregunta) {
                    const tiempo = this.calcularTiempoRespuesta(pregunta);
                    if (tiempo !== null && tiempo < menorTiempo) {
                        menorTiempo = tiempo;
                        masRapida = {
                            pregunta: pregunta,
                            tiempo: tiempo,
                            jugador: this.primerAcertantePorPregunta[pregunta]
                        };
                    }
                }

                return masRapida;
            }

            obtenerPreguntaMasLenta() {
                let masLenta = null;
                let mayorTiempo = 0;

                for (const pregunta in this.tiemposPorPregunta) {
                    const tiempo = this.calcularTiempoRespuesta(pregunta);
                    if (tiempo !== null && tiempo > mayorTiempo) {
                        mayorTiempo = tiempo;
                        masLenta = {
                            pregunta: pregunta,
                            tiempo: tiempo,
                            jugador: this.primerAcertantePorPregunta[pregunta]
                        };
                    }
                }

                return masLenta;
            }

            obtenerMarcadorActual() {
                const equipos = Object.keys(this.puntosEquipo);
                if (equipos.length !== 2) return null;

                return {
                    [equipos[0]]: this.puntosEquipo[equipos[0]],
                    [equipos[1]]: this.puntosEquipo[equipos[1]]
                };
            }

            obtenerTopJugadores(n = 5) {
                return Object.entries(this.puntosPorJugador)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, n)
                    .map(([jugador, puntos]) => ({ jugador, puntos }));
            }

            obtenerAusencias() {
                const ausentes = [];
                for (const equipo in this.equipos) {
                    for (const jugador of this.equipos[equipo]) {
                        if (!this.jugadoresActivos.has(jugador)) {
                            ausentes.push({ jugador, equipo });
                        }
                    }
                }
                return ausentes;
            }

            detectarRachasCortadas(proximaPregunta) {
                const rachasCortadas = [];
                for (const jugador in this.rachaActual) {
                    if (this.rachaActual[jugador] >= 7) {
                        // Si no aparece en la siguiente pregunta, se cortó la racha
                        if (!this.respuestasPorPregunta[proximaPregunta]?.includes(jugador)) {
                            rachasCortadas.push({
                                jugador,
                                racha: this.rachaActual[jugador],
                                equipo: this.jugadorEquipo[jugador]
                            });
                        }
                    }
                }
                return rachasCortadas;
            }

            generarDatosExtra(esPrimera, esUltima, proximaPregunta) {
                let extras = [];
                
                extras.push('\n\n');
                extras.push('═══════════════════════════════════════════');
                extras.push('           📊 DATOS EXTRA DEL CORTE');
                extras.push('═══════════════════════════════════════════');
                extras.push('');

                // En la primera parte: mostrar composición de equipos
                if (esPrimera) {
                    extras.push('🏆 COMPOSICIÓN DE EQUIPOS:');
                    extras.push('─────────────────────────');
                    for (const equipo in this.equipos) {
                        const jugadores = this.equipos[equipo];
                        extras.push(`${equipo}: ${jugadores.length} jugadores`);
                        extras.push(`  Plantilla: ${jugadores.join(', ')}`);
                    }
                    
                    const ausencias = this.obtenerAusencias();
                    if (ausencias.length > 0) {
                        extras.push('');
                        extras.push('⚠️ JUGADORES AUSENTES:');
                        extras.push('─────────────────────────');
                        ausencias.forEach(a => {
                            extras.push(`  ${a.jugador} (${a.equipo})`);
                        });
                    }
                    extras.push('');
                }

                // Marcador actual
                const marcador = this.obtenerMarcadorActual();
                if (marcador) {
                    extras.push('📈 MARCADOR EN EL CORTE:');
                    extras.push('─────────────────────────');
                    for (const equipo in marcador) {
                        extras.push(`  ${equipo}: ${marcador[equipo]} puntos`);
                    }
                    extras.push('');
                }

                // Top jugadores
                const topJugadores = this.obtenerTopJugadores(5);
                if (topJugadores.length > 0) {
                    extras.push('🥇 TOP 5 JUGADORES:');
                    extras.push('─────────────────────────');
                    topJugadores.forEach((j, i) => {
                        extras.push(`  ${i + 1}. ${j.jugador}: ${j.puntos} puntos`);
                    });
                    extras.push('');
                }

                // Rachas cortadas
                if (proximaPregunta) {
                    const rachasCortadas = this.detectarRachasCortadas(proximaPregunta);
                    if (rachasCortadas.length > 0) {
                        extras.push('⚡ RACHAS IMPORTANTES CORTADAS:');
                        extras.push('─────────────────────────');
                        rachasCortadas.forEach(r => {
                            extras.push(`  ${r.jugador} (${r.equipo}): Racha de ${r.racha} cortada`);
                        });
                        extras.push('');
                    }
                }

                // En la última parte: estadísticas completas
                if (esUltima) {
                    extras.push('📊 ESTADÍSTICAS FINALES COMPLETAS:');
                    extras.push('═══════════════════════════════════');
                    extras.push('');

                    // Puntos por jugador
                    extras.push('PUNTOS:');
                    extras.push('─────────────────────────');
                    const jugadoresOrdenados = Object.entries(this.puntosPorJugador)
                        .filter(([j, p]) => p > 0)
                        .sort((a, b) => b[1] - a[1]);
                    
                    jugadoresOrdenados.forEach(([j, p]) => {
                        extras.push(`  ${j}: ${p}`);
                    });
                    extras.push('');

                    // Scratches
                    const scratches = Object.entries(this.scratchesPorJugador)
                        .filter(([j, s]) => s > 0)
                        .sort((a, b) => b[1] - a[1]);
                    
                    if (scratches.length > 0) {
                        extras.push('SCRATCHES:');
                        extras.push('─────────────────────────');
                        scratches.forEach(([j, s]) => {
                            extras.push(`  ${j}: ${s}`);
                        });
                        extras.push('');
                    }

                    // Aces
                    const aces = Object.entries(this.acesPorJugador)
                        .filter(([j, a]) => a > 0)
                        .sort((a, b) => b[1] - a[1]);
                    
                    if (aces.length > 0) {
                        extras.push('ACES:');
                        extras.push('─────────────────────────');
                        aces.forEach(([j, a]) => {
                            extras.push(`  ${j}: ${a}`);
                        });
                        extras.push('');
                    }

                    // Palos
                    const palos = Object.entries(this.palosPorJugador)
                        .filter(([j, p]) => p > 0)
                        .sort((a, b) => b[1] - a[1]);
                    
                    if (palos.length > 0) {
                        extras.push('PALOS:');
                        extras.push('─────────────────────────');
                        palos.forEach(([j, p]) => {
                            extras.push(`  ${j}: ${p}`);
                        });
                        extras.push('');
                    }

                    // Preguntas más rápida y más lenta
                    const masRapida = this.obtenerPreguntaMasRapida();
                    const masLenta = this.obtenerPreguntaMasLenta();

                    if (masRapida || masLenta) {
                        extras.push('⏱️ TIEMPOS DESTACADOS:');
                        extras.push('─────────────────────────');
                        if (masRapida) {
                            extras.push(`  Pregunta más rápida: P${masRapida.pregunta} (${masRapida.tiempo}s) - ${masRapida.jugador}`);
                        }
                        if (masLenta) {
                            extras.push(`  Pregunta más lenta: P${masLenta.pregunta} (${masLenta.tiempo}s) - ${masLenta.jugador}`);
                        }
                        extras.push('');
                    }

                    // Mejores rachas
                    const rachas = Object.entries(this.mejorRacha)
                        .filter(([j, r]) => r >= 5)
                        .sort((a, b) => b[1] - a[1]);
                    
                    if (rachas.length > 0) {
                        extras.push('🔥 MEJORES RACHAS:');
                        extras.push('─────────────────────────');
                        rachas.forEach(([j, r]) => {
                            extras.push(`  ${j}: ${r} consecutivas`);
                        });
                        extras.push('');
                    }
                }

                extras.push('═══════════════════════════════════════════');
                extras.push('\n');

                return extras.join('\n');
            }
        }

        // Elementos del DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');
        const numPartsInput = document.getElementById('numParts');
        const cleanIRCCheckbox = document.getElementById('cleanIRC');
        const addExtrasCheckbox = document.getElementById('addExtras');
        const uploadText = document.getElementById('uploadText');

        // Event listeners
        uploadArea.addEventListener('click', (e) => {
            e.preventDefault();
            fileInput.click();
        });
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });
        
        processBtn.addEventListener('click', processFile);

        function handleFileSelect(file) {
            console.log('Archivo seleccionado:', file.name);
            
            if (!file.name.match(/\.(txt|log)$/i)) {
                showStatus('Por favor, selecciona un archivo .txt o .log', 'error');
                return;
            }
            
            selectedFile = file;
            uploadText.textContent = `📎 ${file.name}`;
            uploadArea.classList.add('file-selected');
            showStatus(`Archivo seleccionado: ${file.name} (${formatFileSize(file
