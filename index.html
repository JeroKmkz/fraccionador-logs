<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fraccionador de Logs - Trivial IRC</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px}
    .container{background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);max-width:700px;width:100%;padding:40px;animation:slideIn .5s ease-out}
    @keyframes slideIn{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    h1{text-align:center;color:#333;margin-bottom:10px;font-size:2em}
    .subtitle{text-align:center;color:#666;margin-bottom:30px;font-size:.9em}
    .upload-area{border:3px dashed #ddd;padding:40px;text-align:center;margin-bottom:30px;border-radius:15px;background:#fafafa;cursor:pointer;transition:.3s}
    .upload-area:hover,.upload-area.dragover{border-color:#667eea;background:#f0f0ff;transform:scale(1.02)}
    .upload-icon{font-size:3em;margin-bottom:10px;color:#667eea}
    .options{margin-bottom:30px;padding:20px;background:#f8f9fa;border-radius:10px}
    .option-group{margin-bottom:20px}
    .option-label{display:block;color:#555;margin-bottom:8px;font-weight:500}
    .option-input{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:1em}
    .checkbox-group{display:flex;align-items:center;gap:10px}
    .checkbox-group input{width:20px;height:20px;cursor:pointer}
    .button{background:#007bff;color:#fff;padding:15px 25px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold;width:100%;margin:10px 0;transition:.3s}
    .button:hover{background:#0056b3}
    .button:disabled{background:#ccc;cursor:not-allowed}
    .button.success{background:#28a745}
    .button.success:hover{background:#218838}
    .results{margin-top:30px;display:none}
    .results.show{display:block}
    .file-item{background:#f8f9fa;border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
    .download-btn{padding:8px 20px;background:#667eea;color:#fff;border:none;border-radius:6px;cursor:pointer;transition:.3s}
    .download-btn:hover{background:#5a67d8}
    .message{padding:15px;margin:10px 0;border-radius:8px}
    .success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .extras-section{background:#f0f4ff;border:2px solid #667eea;border-radius:10px;padding:15px;margin-bottom:20px}
    .extras-title{color:#667eea;font-weight:bold;margin-bottom:10px}
    .file-selected{background:#e8f5e9;border-color:#4caf50}
    small{display:block;color:#6b7280;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>üìÇ Fraccionador de Logs IRC</h1>
    <p class="subtitle">Limpia y divide tus logs de partidas con an√°lisis estad√≠stico</p>

    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div id="uploadText">Arrastra tu archivo aqu√≠ o haz clic para seleccionar</div>
      <input type="file" id="fileInput" accept=".txt,.log" style="display:none"/>
    </div>

    <div class="options">
      <div class="option-group">
        <label class="option-label" for="numPartes">N√∫mero de partes:</label>
        <input type="number" id="numPartes" class="option-input" min="2" max="20" value="4"/>
      </div>

      <div class="option-group">
        <div class="checkbox-group">
          <input type="checkbox" id="cleanIRC" checked/>
          <label for="cleanIRC">Limpiar c√≥digos IRC</label>
        </div>
        <small>Elimina c√≥digos de color/formato IRC. Recomendado para an√°lisis robusto.</small>
      </div>

      <div class="option-group">
        <div class="checkbox-group">
          <input type="checkbox" id="cleanMax" checked/>
          <label for="cleanMax">Limpieza m√°xima (compactar para cr√≥nica)</label>
        </div>
        <small>Quita timestamps, marcador intermedio, "Respuestas acertadas" y "Mandada por‚Ä¶". Mantiene "DATO EXTRA" y "La buena".</small>
      </div>

      <div class="extras-section">
        <div class="extras-title">üìä An√°lisis Extra (para Cronista)</div>
        <div class="checkbox-group">
          <input type="checkbox" id="addExtras"/>
          <label for="addExtras">A√±adir estad√≠sticas y an√°lisis en cada corte</label>
        </div>
      </div>
    </div>

    <button class="button" id="processBtn" style="display:none">Procesar Archivo</button>
    <div id="messages"></div>
    <div id="results" class="results"></div>
  </div>

  <script>
    // Variables globales
    let selectedFile = null;
    
    // Referencias DOM
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadText = document.getElementById('uploadText');
    const processBtn = document.getElementById('processBtn');
    const messages = document.getElementById('messages');
    const results = document.getElementById('results');

    // Event listeners
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if(files.length > 0) handleFile(files[0]);
    });
    
    fileInput.addEventListener('change', (e) => {
      if(e.target.files.length > 0) handleFile(e.target.files[0]);
    });
    
    processBtn.addEventListener('click', processLog);

    // Funci√≥n para limpiar c√≥digos IRC
    function stripIrcCodes(s) {
      if(!s) return s;
      return s
        .replace(/\x03\d{0,2}(?:,\d{1,2})?/g, "") // mIRC colors
        .replace(/[\x02\x1D\x1F\x0F\x16\x7F]/g, "") // otros c√≥digos IRC
        .replace(/\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])/g, ""); // ANSI
    }
    
    function plain(line) { 
      return stripIrcCodes(line); 
    }

    // Limpieza m√°xima para cr√≥nicas
    function limpiarArchivoMax(contenido) {
      const lineas = contenido.split('\n');
      const out = [];
      let skipScore = false;
      let skipAciertos = false;

      for(let i = 0; i < lineas.length; i++) {
        let line = lineas[i];
        const pl = plain(line);

        // Detectar bloques a saltar
        if(skipScore) {
          if(/Pregunta:\s*\d+\s*\/\s*\d+/i.test(pl) || 
             /<[^>]+>/.test(pl) || 
             /La(s)?\s+buena(s)?:/i.test(pl) || 
             /---/.test(pl)) {
            skipScore = false;
          } else {
            continue;
          }
        }
        
        if(skipAciertos) {
          if(/Pregunta:\s*\d+\s*\/\s*\d+/i.test(pl) || 
             /<[^>]+>/.test(pl) || 
             /La(s)?\s+buena(s)?:/i.test(pl) || 
             /---/.test(pl)) {
            skipAciertos = false;
          } else {
            continue;
          }
        }

        // Detectar inicio de bloques
        if(/Puntuaci√≥n\s+de\s+equipos/i.test(pl)) {
          skipScore = true;
          continue;
        }
        
        if(/Respuestas\s+acertadas/i.test(pl)) {
          skipAciertos = true;
          continue;
        }

        // Detectar y omitir l√≠neas de ranking
        const plSinBot = pl.replace(/<[^>]+>\s*/, '');
        
        // Puntuaciones individuales: "4 ¬∑CLYDE82‚ÄìDANI_1026‚Äì"
        if(/^\d+\s*¬∑/.test(plSinBot)) continue;
        
        // Puntuaciones de equipos: "1¬∫ 15 LIDERES"
        if(/^\d+¬∫\s+\d+\s+\w+/.test(plSinBot)) continue;

        // Limpiezas de l√≠nea
        // Quitar 'Mandada por: ...'
        if(/La(s)?\s+buena(s)?:/i.test(pl)) {
          line = line.replace(/(\bLa(?:s)?\s+buena(?:s)?:[^]*?)(\s+Mandada\s+por:.*)$/i, "$1");
        }

        // Eliminar "Base Datos Preguntas: ..."
        line = line.replace(/\s*Base\s+Datos\s+Preguntas:\s*\S*/gi, "");

        // Quitar timestamps
        line = line.replace(/^\d{2}:\d{2}:\d{2}(?:''\d+)?\s*/, "");

        // Quitar s√≠mbolo '<' inicial de nicks
        line = line.replace(/^<([^>]+)>/, "$1>");

        // Cambiar >>> por >>
        line = line.replace(/>>>/g, ">>");

        // Filtrar l√≠neas muy cortas
        const short = pl.trim().toLowerCase();
        if(short.length <= 6 && /^(x+d+|j+a+ja+|j+e+je+|lol+|lmao+|uy+|uff+|ah+|em+)$/.test(short)) {
          continue;
        }

        out.push(line);
      }
      
      return out.join('\n');
    }

    // Clase para an√°lisis de partida
    class AnalizadorPartida {
      constructor() {
        this.equipos = {};
        this.jugadorEquipo = {};
        this.botNick = null;
        this.jugadoresActivos = new Set();
        this.contenidoCompleto = '';
        this.totalPreguntas = null;
        this.recordsGlobales = null;
      }

      identificarBot(contenido) {
        this.contenidoCompleto = contenido;
        for(const linea of contenido.split('\n')) {
          const pl = plain(linea);
          if(pl.includes('--- Equipos participantes ---')) {
            const m = pl.match(/<([^>]+)>/);
            if(m) {
              this.botNick = m[1];
              console.log('Bot identificado:', this.botNick);
              return;
            }
          }
        }
      }

      procesarEquipos(contenido) {
        const lineas = contenido.split('\n');
        let dentro = false;
        let equipoActual = null;
        
        for(const linea of lineas) {
          const pl = plain(linea);
          
          if(pl.includes('--- Equipos participantes ---')) {
            dentro = true;
            continue;
          }
          
          if(pl.includes('--- DATOS RESETEADOS ---')) {
            dentro = false;
            break;
          }
          
          if(dentro && this.botNick && pl.includes(`<${this.botNick}>`)) {
            if(!pl.includes('>>>')) {
              const equipos = ['FOGUETES', 'LIDERES', 'KAMIKAZES', 'ATIPIK@S', 'REPESCA@S', 'HARDBE@TS', 'TELERINEZ'];
              for(const eq of equipos) {
                if(pl.includes(eq)) {
                  equipoActual = eq;
                  this.equipos[eq] = [];
                  break;
                }
              }
            } else if(equipoActual) {
              const m = pl.match(/>>>\s*(.+)/);
              if(m) {
                const jugadores = m[1].trim().split(/\s+/);
                this.equipos[equipoActual] = jugadores;
                jugadores.forEach(j => {
                  this.jugadorEquipo[j] = equipoActual;
                });
              }
            }
          }
        }
        
        this.detectarJugadoresActivos();
      }

      detectarJugadoresActivos() {
        for(const linea of this.contenidoCompleto.split('\n')) {
          const pl = plain(linea);
          const m = pl.match(/<([^>]+)>/);
          if(!m) continue;
          
          const nick = m[1];
          if(nick === this.botNick) continue;
          
          for(const jugador in this.jugadorEquipo) {
            if(nick.toLowerCase() === jugador.toLowerCase()) {
              this.jugadoresActivos.add(jugador);
            }
          }
        }
      }

      precomputarRecords(contenido) {
        // Implementaci√≥n simplificada
        this.recordsGlobales = {
          dificultad: null,
          parciales: [],
          racha: null
        };
      }

      generarResumen(contenidoHastaAqui, esPrimera, esUltima) {
        const extras = [];
        
        extras.push('\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        extras.push('           üìä DATOS EXTRA DEL CORTE');
        extras.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        
        if(esPrimera) {
          extras.push('üèÜ EQUIPOS PARTICIPANTES:');
          for(const eq in this.equipos) {
            extras.push(`${eq}: ${this.equipos[eq].join(', ')}`);
          }
        }
        
        extras.push('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
        return extras.join('\n');
      }
    }

    // Funciones de limpieza b√°sica
    function limpiarLinea(linea) {
      return linea
        .replace(/\x03\d{0,2}(?:,\d{1,2})?/g, "")
        .replace(/[\x02\x1D\x1F\x0F\x16\x7F]/g, "")
        .replace(/\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])/g, "")
        .replace(/\s{2,}/g, " ")
        .trim();
    }
    
    function limpiarArchivo(contenido) {
      return contenido.split("\n").map(limpiarLinea).join("\n");
    }

    // Buscar posiciones de preguntas
    function encontrarPosicionesPreguntas(contenido) {
      const pos = [];
      const lineas = contenido.split("\n");
      
      for(let i = 0; i < lineas.length; i++) {
        const pl = plain(lineas[i]);
        if(/Pregunta:\s*\d+\s*\/\s*\d+/i.test(pl)) {
          pos.push(i);
        }
      }
      
      return pos;
    }

    // Dividir archivo
    function dividirArchivo(contenido, numPartes) {
      const lineas = contenido.split("\n");
      const posiciones = encontrarPosicionesPreguntas(contenido);
      
      if(!posiciones.length) {
        throw new Error("No se encontraron preguntas en el archivo");
      }
      
      const total = lineas.length;
      const porParte = Math.floor(total / numPartes);
      const cortes = [];
      let ultimo = 0;
      
      for(let i = 1; i < numPartes; i++) {
        const objetivo = i * porParte;
        let mejor = ultimo;
        
        for(const p of posiciones) {
          if(p <= objetivo && p > ultimo) {
            mejor = p;
          }
        }
        
        if(mejor > ultimo) {
          cortes.push(mejor);
          ultimo = mejor;
        }
      }
      
      const partes = [];
      let inicio = 0;
      const finales = [...cortes, total];
      
      finales.forEach((fin, idx) => {
        const fragmento = lineas.slice(inicio, fin).join("\n");
        partes.push({
          nombre: `parte_${String(idx + 1).padStart(2, '0')}.txt`,
          contenido: fragmento,
          lineas: fin - inicio
        });
        inicio = fin;
      });
      
      return partes;
    }

    // Manejar archivo
    function handleFile(file) {
      if(!file.name.match(/\.(txt|log)$/i)) {
        showMessage('Por favor selecciona un archivo .txt o .log', 'error');
        return;
      }
      
      selectedFile = file;
      uploadText.textContent = `üìé ${file.name}`;
      uploadArea.classList.add('file-selected');
      processBtn.style.display = 'block';
      showMessage('Archivo cargado correctamente: ' + file.name, 'success');
    }

    // Procesar log
    function processLog() {
      if(!selectedFile) {
        showMessage("Selecciona un archivo primero", 'error');
        return;
      }
      
      const numPartes = parseInt(document.getElementById('numPartes').value) || 4;
      const cleanIRC = document.getElementById('cleanIRC').checked;
      const cleanMax = document.getElementById('cleanMax').checked;
      const addExtras = document.getElementById('addExtras').checked;
      
      showMessage('Procesando archivo...', 'success');
      
      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          let contenido = e.target.result;
          
          if(cleanIRC) {
            contenido = limpiarArchivo(contenido);
          }
          
          let analizador = null;
          if(addExtras) {
            analizador = new AnalizadorPartida();
            analizador.identificarBot(contenido);
            analizador.procesarEquipos(contenido);
          }
          
          if(cleanMax) {
            contenido = limpiarArchivoMax(contenido);
          }
          
          const partes = dividirArchivo(contenido, numPartes);
          
          if(addExtras && analizador) {
            let acumulado = '';
            partes.forEach((parte, idx) => {
              acumulado += parte.contenido;
              const esPrimera = (idx === 0);
              const esUltima = (idx === partes.length - 1);
              const extras = analizador.generarResumen(acumulado, esPrimera, esUltima);
              parte.contenido += extras;
            });
          }
          
          mostrarResultados(partes, numPartes);
          
        } catch(err) {
          console.error('Error:', err);
          showMessage("Error: " + err.message, 'error');
        }
      };
      
      reader.onerror = function() {
        showMessage('Error al leer el archivo', 'error');
      };
      
      reader.readAsText(selectedFile, 'utf-8');
    }

    // Mostrar resultados
    function mostrarResultados(partes, numPartes) {
      results.innerHTML = `<h3>üì¶ Archivos Generados (${numPartes} partes)</h3>`;
      
      partes.forEach(parte => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        
        const info = document.createElement('div');
        info.innerHTML = `<strong>${parte.nombre}</strong><br>${parte.lineas} l√≠neas | ${formatFileSize(parte.contenido.length)}`;
        
        const btn = document.createElement('button');
        btn.className = 'download-btn';
        btn.textContent = 'Descargar';
        btn.onclick = () => descargarParte(parte.nombre, parte.contenido);
        
        fileItem.appendChild(info);
        fileItem.appendChild(btn);
        results.appendChild(fileItem);
      });
      
      if(partes.length > 1) {
        const btnZip = document.createElement('button');
        btnZip.className = 'button success';
        btnZip.textContent = 'üì¶ Descargar todas en ZIP';
        btnZip.onclick = () => descargarZip(partes);
        results.appendChild(btnZip);
      }
      
      results.classList.add('show');
      showMessage(`Log procesado correctamente en ${numPartes} partes`, 'success');
    }

    // Descargar parte
    function descargarParte(nombre, contenido) {
      const blob = new Blob([contenido], {type: "text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = nombre;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Descargar ZIP
    async function descargarZip(partes) {
      try {
        showMessage('Generando archivo ZIP...', 'success');
        const zip = new JSZip();
        
        partes.forEach(p => {
          zip.file(p.nombre, p.contenido);
        });
        
        const blob = await zip.generateAsync({type: "blob"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "partes_trivial.zip";
        a.click();
        URL.revokeObjectURL(url);
        
        showMessage('ZIP descargado correctamente', 'success');
      } catch(e) {
        showMessage('Error al generar el archivo ZIP', 'error');
      }
    }

    // Formatear tama√±o
    function formatFileSize(bytes) {
      if(bytes < 1024) return bytes + ' bytes';
      if(bytes < 1048576) return Math.round(bytes / 1024) + ' KB';
      return Math.round(bytes / 1048576) + ' MB';
    }

    // Mostrar mensaje
    function showMessage(msg, type) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.textContent = msg;
      messages.appendChild(div);
      
      setTimeout(() => {
        if(div.parentNode) {
          div.parentNode.removeChild(div);
        }
      }, 5000);
    }
  </script>
</body>
</html>
